<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê´€ë¦¬ì Â· ë°ì´í„° ì—…ë°ì´íŠ¸</title>
<style>
  :root{--bg:#ffffff;--card:#fff;--text:#0b1020;--muted:#606a7a;--accent:#1d4ed8;--border:#e5e7eb;--badge:#f1f5f9}
  *{box-sizing:border-box}
  html,body{margin:0;background:#f9fafb;color:var(--text);font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:680px;margin:40px auto;padding:0 16px}
  header{text-align:center;margin-bottom:32px}
  h1{font-size:24px;margin:0 0 8px;font-weight:900}
  .subtitle{color:var(--muted);font-size:14px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:16px}
  .card-small{padding:16px}
  .status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:700;font-size:14px}
  .status-badge.idle{background:#f1f5f9;color:#475569}
  .status-badge.running{background:#fef3c7;color:#92400e}
  .status-badge.success{background:#dcfce7;color:#166534}
  .status-badge.error{background:#fee2e2;color:#991b1b}
  .status-badge.fresh{background:#dbeafe;color:#1e40af}
  .status-badge.locked{background:#fef3c7;color:#92400e}
  .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:12px;border:none;font-weight:800;font-size:15px;cursor:pointer;transition:all 0.2s}
  .btn:disabled{opacity:0.5;cursor:not-allowed}
  .btn-primary{background:#1d4ed8;color:#fff}
  .btn-primary:hover:not(:disabled){background:#1e40af;transform:translateY(-2px);box-shadow:0 4px 12px rgba(29,78,216,0.3)}
  .btn-secondary{background:#f1f5f9;color:#475569;border:1px solid var(--border)}
  .btn-secondary:hover:not(:disabled){background:#e2e8f0}
  .btn-small{padding:10px;font-size:13px}
  .alert{padding:12px 16px;border-radius:10px;margin:16px 0;font-size:13px;font-weight:600}
  .alert-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
  .alert-success{background:#dcfce7;color:#166534;border:1px solid #86efac}
  .alert-error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
  .alert-warning{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
  .log-item{padding:8px 12px;background:#f8fafc;border-left:3px solid #cbd5e1;margin:8px 0;border-radius:4px;font-size:13px}
  .log-item.success{border-left-color:#22c55e}
  .log-item.error{border-left-color:#ef4444}
  .log-item.running{border-left-color:#f59e0b}
  footer{text-align:center;margin-top:32px;font-size:12px;color:var(--muted)}
  .link{color:var(--accent);text-decoration:none;font-weight:700}
  #logContainer{max-height:300px;overflow-y:auto;margin-top:16px}
  .input-group{margin-bottom:12px}
  .input-group label{display:block;margin-bottom:6px;font-weight:600;font-size:13px}
  .input-group input{width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:13px;font-family:monospace}
  .input-group input:focus{outline:none;border-color:var(--accent)}
  .help-text{font-size:11px;color:var(--muted);margin-top:4px}
  .token-saved{background:#dcfce7;color:#166534;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:12px;display:none}
  .data-status{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:20px;border-radius:12px;margin-bottom:16px}
  .data-status-title{font-size:13px;opacity:0.9;margin-bottom:8px;font-weight:600}
  .data-status-time{font-size:24px;font-weight:900;margin-bottom:4px}
  .data-status-label{font-size:13px;opacity:0.85;display:flex;align-items:center;gap:6px}
  .freshness-indicator{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,255,255,0.2);border-radius:999px;font-size:12px;font-weight:700}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:16px}
  .stat-item{background:#f8fafc;padding:12px;border-radius:8px;text-align:center}
  .stat-value{font-size:20px;font-weight:900;color:var(--accent);margin-bottom:4px}
  .stat-label{font-size:12px;color:var(--muted)}
  .token-section{background:#fffbeb;border:2px dashed #fbbf24;padding:12px;border-radius:8px;margin-bottom:16px}
  .token-section-title{font-size:13px;font-weight:700;margin-bottom:8px;color:#92400e;display:flex;align-items:center;gap:6px}
  .collapse-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s}
  .collapse-btn:hover{background:#f3f4f6}
  .token-content{overflow:hidden;transition:all 0.3s ease}
  .token-content.collapsed{max-height:0;opacity:0}
  .token-content.expanded{max-height:500px;opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸ”§ ê´€ë¦¬ì íŒ¨ë„</h1>
    <p class="subtitle">GitHub Actions ê¸°ë°˜ ë°ì´í„° ì—…ë°ì´íŠ¸</p>
  </header>

  <!-- ë°ì´í„° ìƒíƒœ ì¹´ë“œ -->
  <div class="card">
    <div class="data-status">
      <div class="data-status-title">ë§ˆì§€ë§‰ ë°ì´í„° ì—…ë°ì´íŠ¸</div>
      <div class="data-status-time" id="lastUpdateTime">í™•ì¸ ì¤‘...</div>
      <div class="data-status-label">
        <span id="freshnessIndicator" class="freshness-indicator">
          âœ¨ í™•ì¸ ì¤‘...
        </span>
      </div>
    </div>

    <div class="stats-grid" id="statsGrid" style="display:none">
      <div class="stat-item">
        <div class="stat-value" id="timeSinceUpdate">-</div>
        <div class="stat-label">ê²½ê³¼ ì‹œê°„</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="nextScheduled">-</div>
        <div class="stat-label">ë‹¤ìŒ ìë™ ì—…ë°ì´íŠ¸</div>
      </div>
    </div>
  </div>

  <!-- í† í° ì…ë ¥ ì„¹ì…˜ (ì‘ê³  ì ‘ì„ ìˆ˜ ìˆìŒ) -->
  <div class="card card-small">
    <div class="token-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="token-section-title">
          <span>ğŸ”</span>
          <span id="tokenStatusText">ìˆ˜ë™ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ í† í° í•„ìš”</span>
        </div>
        <button id="toggleTokenBtn" class="collapse-btn">â–¼ í¼ì¹˜ê¸°</button>
      </div>
      
      <div id="tokenContent" class="token-content collapsed">
        <div style="margin-top:12px">
          <div class="input-group">
            <label for="tokenInput">GitHub Personal Access Token</label>
            <input 
              type="password" 
              id="tokenInput" 
              placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
              autocomplete="off"
            />
            <div class="help-text">
              ğŸ”— <a href="https://github.com/settings/tokens/new?scopes=repo,workflow" target="_blank" class="link">í† í° ìƒì„±</a> (repo, workflow ê¶Œí•œ í•„ìš”)
            </div>
          </div>

          <button id="saveTokenBtn" class="btn btn-primary btn-small">
            <span>ğŸ’¾</span>
            <span>í† í° ì €ì¥</span>
          </button>

          <div id="tokenSaved" class="token-saved">
            âœ… í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨íŠ¸ë¡¤ ì¹´ë“œ -->
  <div class="card" id="mainCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;font-size:16px">ìˆ˜ë™ ì—…ë°ì´íŠ¸</h3>
      <span id="statusBadge" class="status-badge locked">ğŸ”’ í† í° í•„ìš”</span>
    </div>

    <button id="updateBtn" class="btn btn-primary" disabled>
      <span>ğŸ”„</span>
      <span>ì§€ê¸ˆ ë°”ë¡œ ì—…ë°ì´íŠ¸ ì‹¤í–‰</span>
    </button>

    <button id="changeTokenBtn" class="btn btn-secondary" style="margin-top:8px;display:none">
      <span>ğŸ”‘</span>
      <span>í† í° ë³€ê²½í•˜ê¸°</span>
    </button>

    <div id="infoBox" class="alert alert-info">
      â° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ GitHub Actions ì›Œí¬í”Œë¡œìš°ê°€ ì¦‰ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤.<br>
      ì•½ 5~10ë¶„ í›„ ë°ì´í„°ê°€ ê°±ì‹ ë©ë‹ˆë‹¤. (ìë™ ì—…ë°ì´íŠ¸ëŠ” ë§¤ì¼ ìì •ì— ì‹¤í–‰ë©ë‹ˆë‹¤)
    </div>

    <div id="needTokenBox" class="alert alert-warning">
      ğŸ” ìˆ˜ë™ ì—…ë°ì´íŠ¸ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ìœ„ì˜ í† í° ì„¹ì…˜ì—ì„œ GitHub Personal Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
      í† í° ì—†ì´ë„ ìë™ ì—…ë°ì´íŠ¸(ë§¤ì¼ ìì •)ëŠ” ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.
    </div>

    <div id="successBox" class="alert alert-success" style="display:none"></div>
    <div id="errorBox" class="alert alert-error" style="display:none"></div>

    <div id="logContainer"></div>
  </div>

  <!-- ìµœê·¼ ì—…ë°ì´íŠ¸ ê¸°ë¡ -->
  <div class="card" id="historyCard">
    <h3 style="margin:0 0 12px;font-size:16px">ìµœê·¼ ì—…ë°ì´íŠ¸ ê¸°ë¡</h3>
    <div id="recentRuns" style="font-size:13px;color:var(--muted)">
      <div class="alert alert-warning" style="margin:0">
        ğŸ” ì—…ë°ì´íŠ¸ ê¸°ë¡ì„ ë³´ë ¤ë©´ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
      </div>
    </div>
  </div>

  <!-- ë¹ ë¥¸ ì´ë™ -->
  <div class="card">
    <h3 style="margin:0 0 12px;font-size:16px">ë¹ ë¥¸ ì´ë™</h3>
    <div style="display:grid;gap:8px">
      <a href="./index.html" class="btn btn-secondary">ğŸ“‹ ì±„ìš© ê³µê³  ë³´ê¸°</a>
      <a href="./guestbook.html" class="btn btn-secondary">ğŸ’¬ ê±´ì˜ì‚¬í•­ ê²Œì‹œíŒ</a>
      <a href="https://github.com/Kimseungwoo0407/hospital-jobs/actions" target="_blank" class="btn btn-secondary">âš™ï¸ GitHub Actions ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°</a>
    </div>
  </div>

  <footer>
    GitHub Pages Â· Python Crawler Â· Automated Workflow
  </footer>
</div>

<script>
const OWNER = "Kimseungwoo0407";
const REPO = "hospital-jobs";
const WORKFLOW_FILE = "crawl.yml";

// ì„¸ì…˜ ì €ì¥ì†Œ í‚¤
const TOKEN_KEY = 'gh_admin_token';

const statusBadge = document.getElementById('statusBadge');
const updateBtn = document.getElementById('updateBtn');
const infoBox = document.getElementById('infoBox');
const needTokenBox = document.getElementById('needTokenBox');
const successBox = document.getElementById('successBox');
const errorBox = document.getElementById('errorBox');
const logContainer = document.getElementById('logContainer');
const recentRuns = document.getElementById('recentRuns');
const mainCard = document.getElementById('mainCard');
const historyCard = document.getElementById('historyCard');
const tokenInput = document.getElementById('tokenInput');
const saveTokenBtn = document.getElementById('saveTokenBtn');
const changeTokenBtn = document.getElementById('changeTokenBtn');
const tokenSaved = document.getElementById('tokenSaved');
const lastUpdateTime = document.getElementById('lastUpdateTime');
const freshnessIndicator = document.getElementById('freshnessIndicator');
const timeSinceUpdate = document.getElementById('timeSinceUpdate');
const nextScheduled = document.getElementById('nextScheduled');
const statsGrid = document.getElementById('statsGrid');
const tokenStatusText = document.getElementById('tokenStatusText');
const toggleTokenBtn = document.getElementById('toggleTokenBtn');
const tokenContent = document.getElementById('tokenContent');

let checkInterval = null;
let isRunning = false;
let lastSuccessfulRun = null;

// í† í° ê°€ì ¸ì˜¤ê¸°
function getToken() {
  return sessionStorage.getItem(TOKEN_KEY);
}

// í† í° ì €ì¥
function saveToken(token) {
  sessionStorage.setItem(TOKEN_KEY, token);
}

// í† í° ì‚­ì œ
function clearToken() {
  sessionStorage.removeItem(TOKEN_KEY);
}

// í† í° ì„¹ì…˜ í† ê¸€
toggleTokenBtn.addEventListener('click', () => {
  if (tokenContent.classList.contains('collapsed')) {
    tokenContent.classList.remove('collapsed');
    tokenContent.classList.add('expanded');
    toggleTokenBtn.textContent = 'â–² ì ‘ê¸°';
  } else {
    tokenContent.classList.remove('expanded');
    tokenContent.classList.add('collapsed');
    toggleTokenBtn.textContent = 'â–¼ í¼ì¹˜ê¸°';
  }
});

// ì‹œê°„ ì°¨ì´ ê³„ì‚°
function getTimeAgo(date) {
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (days > 0) return `${days}ì¼ ì „`;
  if (hours > 0) return `${hours}ì‹œê°„ ì „`;
  if (minutes > 0) return `${minutes}ë¶„ ì „`;
  return 'ë°©ê¸ˆ ì „';
}

// ë‹¤ìŒ ìì •ê¹Œì§€ ì‹œê°„ ê³„ì‚°
function getTimeUntilMidnight() {
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);
  
  const diff = tomorrow - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  
  return `${hours}ì‹œê°„ ${minutes}ë¶„`;
}

// ë°ì´í„° ì‹ ì„ ë„ í‘œì‹œ
function updateDataFreshness(lastRun) {
  if (!lastRun) {
    freshnessIndicator.innerHTML = 'â“ ì—…ë°ì´íŠ¸ ê¸°ë¡ ì—†ìŒ';
    lastUpdateTime.textContent = 'í† í° ì…ë ¥ í›„ í™•ì¸ ê°€ëŠ¥';
    return;
  }

  const runDate = new Date(lastRun.updated_at);
  const now = new Date();
  const hoursSince = (now - runDate) / (1000 * 60 * 60);

  lastUpdateTime.textContent = runDate.toLocaleString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });

  timeSinceUpdate.textContent = getTimeAgo(runDate);
  nextScheduled.textContent = getTimeUntilMidnight();
  statsGrid.style.display = 'grid';

  if (hoursSince < 1) {
    freshnessIndicator.innerHTML = 'âœ¨ ìµœì‹  ë°ì´í„°';
    freshnessIndicator.style.background = 'rgba(34, 197, 94, 0.3)';
  } else if (hoursSince < 12) {
    freshnessIndicator.innerHTML = 'âœ… ìµœê·¼ ë°ì´í„°';
    freshnessIndicator.style.background = 'rgba(59, 130, 246, 0.3)';
  } else if (hoursSince < 24) {
    freshnessIndicator.innerHTML = 'â° ë‹¹ì¼ ë°ì´í„°';
    freshnessIndicator.style.background = 'rgba(245, 158, 11, 0.3)';
  } else {
    freshnessIndicator.innerHTML = 'âš ï¸ ì˜¤ë˜ëœ ë°ì´í„°';
    freshnessIndicator.style.background = 'rgba(239, 68, 68, 0.3)';
  }
}

// UI ì—…ë°ì´íŠ¸
function updateUI() {
  const token = getToken();
  
  if (token) {
    // í† í°ì´ ìˆì„ ë•Œ
    tokenStatusText.textContent = 'âœ… í† í° ì €ì¥ë¨ - ìˆ˜ë™ ì—…ë°ì´íŠ¸ ê°€ëŠ¥';
    statusBadge.textContent = 'â¸ï¸ ëŒ€ê¸° ì¤‘';
    statusBadge.className = 'status-badge idle';
    updateBtn.disabled = false;
    changeTokenBtn.style.display = 'block';
    needTokenBox.style.display = 'none';
    tokenContent.classList.remove('expanded');
    tokenContent.classList.add('collapsed');
    toggleTokenBtn.textContent = 'â–¼ í¼ì¹˜ê¸°';
    loadRecentRuns();
  } else {
    // í† í°ì´ ì—†ì„ ë•Œ
    tokenStatusText.textContent = 'ìˆ˜ë™ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ í† í° í•„ìš”';
    statusBadge.textContent = 'ğŸ”’ í† í° í•„ìš”';
    statusBadge.className = 'status-badge locked';
    updateBtn.disabled = true;
    changeTokenBtn.style.display = 'none';
    needTokenBox.style.display = 'block';
    
    // í† í° ì—†ì´ë„ ê¸°ë³¸ ì •ë³´ëŠ” í‘œì‹œ
    lastUpdateTime.textContent = 'í† í° ì…ë ¥ í›„ ì •í™•í•œ ì‹œê°„ í™•ì¸ ê°€ëŠ¥';
    freshnessIndicator.innerHTML = 'ğŸ”’ í† í° í•„ìš”';
    
    recentRuns.innerHTML = `
      <div class="alert alert-warning" style="margin:0">
        ğŸ” ì—…ë°ì´íŠ¸ ê¸°ë¡ì„ ë³´ë ¤ë©´ ìœ„ì—ì„œ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
        <small>ìë™ ì—…ë°ì´íŠ¸(ë§¤ì¼ ìì •)ëŠ” í† í° ì—†ì´ë„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.</small>
      </div>
    `;
  }
}

// ë¡œê·¸ ì¶”ê°€
function addLog(message, type = 'info') {
  const log = document.createElement('div');
  log.className = `log-item ${type}`;
  log.textContent = `${new Date().toLocaleTimeString('ko-KR')} - ${message}`;
  logContainer.insertBefore(log, logContainer.firstChild);
}

// ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìƒíƒœ í™•ì¸
async function checkWorkflowStatus() {
  const token = getToken();
  if (!token) return;

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=1`,
      {
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        }
      }
    );

    if (res.ok) {
      const data = await res.json();
      if (data.workflow_runs && data.workflow_runs.length > 0) {
        const latestRun = data.workflow_runs[0];
        updateStatus(latestRun.status, latestRun.conclusion);
        
        // ì™„ë£Œë˜ë©´ ì²´í¬ ì¤‘ì§€
        if (latestRun.status === 'completed') {
          if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
          }
          
          if (latestRun.conclusion === 'success') {
            successBox.textContent = `âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ! (${new Date(latestRun.updated_at).toLocaleString('ko-KR')})`;
            successBox.style.display = 'block';
            addLog('ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
            lastSuccessfulRun = latestRun;
            updateDataFreshness(latestRun);
          } else {
            errorBox.textContent = `âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${latestRun.conclusion}`;
            errorBox.style.display = 'block';
            addLog(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${latestRun.conclusion}`, 'error');
          }
        }
      }
    }
  } catch (err) {
    console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', err);
  }
}

// ìƒíƒœ ì—…ë°ì´íŠ¸
function updateStatus(status, conclusion) {
  if (status === 'in_progress' || status === 'queued') {
    statusBadge.textContent = 'ğŸš€ ì‹¤í–‰ ì¤‘...';
    statusBadge.className = 'status-badge running';
    updateBtn.disabled = true;
    isRunning = true;
  } else if (status === 'completed') {
    if (conclusion === 'success') {
      statusBadge.textContent = 'âœ… ì™„ë£Œ';
      statusBadge.className = 'status-badge success';
    } else {
      statusBadge.textContent = 'âŒ ì‹¤íŒ¨';
      statusBadge.className = 'status-badge error';
    }
    updateBtn.disabled = false;
    isRunning = false;
  }
}

// ìµœê·¼ ì‹¤í–‰ ê¸°ë¡ ë¡œë“œ
async function loadRecentRuns() {
  const token = getToken();
  if (!token) {
    return;
  }

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=10`,
      {
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        }
      }
    );

    if (res.ok) {
      const data = await res.json();
      if (data.workflow_runs && data.workflow_runs.length > 0) {
        // ê°€ì¥ ìµœê·¼ ì„±ê³µí•œ ì‹¤í–‰ ì°¾ê¸°
        const successfulRun = data.workflow_runs.find(run => 
          run.status === 'completed' && run.conclusion === 'success'
        );
        
        if (successfulRun) {
          lastSuccessfulRun = successfulRun;
          updateDataFreshness(successfulRun);
        }

        let html = '<div style="display:grid;gap:8px">';
        data.workflow_runs.slice(0, 5).forEach(run => {
          const icon = run.conclusion === 'success' ? 'âœ…' : 
                      run.conclusion === 'failure' ? 'âŒ' : 'â³';
          const status = run.status === 'completed' ? run.conclusion : run.status;
          const date = new Date(run.created_at).toLocaleString('ko-KR');
          html += `
            <div style="padding:8px;background:#f8fafc;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
              <span>${icon} ${status}</span>
              <span style="color:var(--muted);font-size:12px">${date}</span>
            </div>
          `;
        });
        html += '</div>';
        recentRuns.innerHTML = html;
        
        // ìµœì‹  ì‹¤í–‰ì´ ì§„í–‰ ì¤‘ì´ë©´ ìë™ìœ¼ë¡œ ìƒíƒœ ì²´í¬ ì‹œì‘
        const latestRun = data.workflow_runs[0];
        if (latestRun.status !== 'completed') {
          updateStatus(latestRun.status, latestRun.conclusion);
          startStatusCheck();
        } else {
          updateStatus(latestRun.status, latestRun.conclusion);
        }
      } else {
        recentRuns.textContent = 'ì•„ì§ ì‹¤í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
        lastUpdateTime.textContent = 'ì—…ë°ì´íŠ¸ ê¸°ë¡ ì—†ìŒ';
        freshnessIndicator.innerHTML = 'â“ ë°ì´í„° ì—†ìŒ';
      }
    } else {
      recentRuns.textContent = 'ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }
  } catch (err) {
    recentRuns.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
  }
}

// ìƒíƒœ ì²´í¬ ì‹œì‘
function startStatusCheck() {
  if (checkInterval) clearInterval(checkInterval);
  checkInterval = setInterval(checkWorkflowStatus, 10000);
  checkWorkflowStatus();
}

// í¬ë¡¤ë§ ì‹¤í–‰
async function triggerCrawl() {
  const token = getToken();

  if (!token) {
    alert("âŒ í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  if (isRunning) {
    alert("âš ï¸ ì´ë¯¸ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\nì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
    return;
  }

  updateBtn.disabled = true;
  isRunning = true;
  statusBadge.textContent = "ğŸš€ ì‹¤í–‰ ìš”ì²­ ì¤‘...";
  statusBadge.className = "status-badge running";
  successBox.style.display = 'none';
  errorBox.style.display = 'none';
  needTokenBox.style.display = 'none';
  
  addLog('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìš”ì²­ ì‹œì‘', 'info');

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches`,
      {
        method: "POST",
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        },
        body: JSON.stringify({ ref: "main" }),
      }
    );

    if (res.ok || res.status === 204) {
      statusBadge.textContent = "ğŸš€ ì‹¤í–‰ ì¤‘...";
      statusBadge.className = "status-badge running";
      infoBox.style.display = 'none';
      addLog('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œì‘ë¨', 'running');
      
      setTimeout(() => {
        startStatusCheck();
        loadRecentRuns();
      }, 3000);
      
    } else {
      const text = await res.text();
      statusBadge.textContent = "âŒ ì˜¤ë¥˜";
      statusBadge.className = "status-badge error";
      errorBox.style.display = "block";
      errorBox.textContent = `ì‹¤í–‰ ì‹¤íŒ¨: ${text}`;
      addLog(`ì‹¤í–‰ ì‹¤íŒ¨: ${text}`, 'error');
      isRunning = false;
    }
  } catch (err) {
    statusBadge.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
    statusBadge.className = "status-badge error";
    errorBox.style.display = "block";
    errorBox.textContent = `ì˜¤ë¥˜: ${err.message}`;
    addLog(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`, 'error');
    isRunning = false;
  } finally {
    updateBtn.disabled = isRunning;
  }
}

// í† í° ì €ì¥ ë²„íŠ¼ í´ë¦­
saveTokenBtn.addEventListener('click', () => {
  const token = tokenInput.value.trim();
  
  if (!token) {
    alert('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
    alert('âš ï¸ ì˜¬ë°”ë¥¸ GitHub Personal Access Token í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\nghp_ ë˜ëŠ” github_pat_ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
  
  saveToken(token);
  tokenSaved.style.display = 'block';
  
  setTimeout(() => {
    updateUI();
    tokenSaved.style.display = 'none';
  }, 1500);
});

// í† í° ë³€ê²½ ë²„íŠ¼ í´ë¦­
changeTokenBtn.addEventListener('click', () => {
  if (confirm('í† í°ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.')) {
    clearToken();
    tokenInput.value = '';
    tokenSaved.style.display = 'none';
    tokenContent.classList.remove('collapsed');
    tokenContent.classList.add('expanded');
    toggleTokenBtn.textContent = 'â–² ì ‘ê¸°';
    updateUI();
  }
});

// ì—…ë°ì´íŠ¸ ë²„íŠ¼ í´ë¦­
updateBtn.addEventListener('click', triggerCrawl);

// Enter í‚¤ë¡œ í† í° ì €ì¥
tokenInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    saveTokenBtn.click();
  }
});

// í˜ì´ì§€ ë¡œë“œì‹œ UI ì´ˆê¸°í™”
updateUI();

// 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
setInterval(() => {
  if (lastSuccessfulRun) {
    timeSinceUpdate.textContent = getTimeAgo(new Date(lastSuccessfulRun.updated_at));
    nextScheduled.textContent = getTimeUntilMidnight();
  } else {
    nextScheduled.textContent = getTimeUntilMidnight();
  }
}, 60000);
</script>
</body>
</html>