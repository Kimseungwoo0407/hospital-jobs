<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê´€ë¦¬ì Â· ë°ì´í„° ì—…ë°ì´íŠ¸</title>
<style>
  :root{--bg:#ffffff;--card:#fff;--text:#0b1020;--muted:#606a7a;--accent:#1d4ed8;--border:#e5e7eb;--badge:#f1f5f9}
  *{box-sizing:border-box}
  html,body{margin:0;background:#f9fafb;color:var(--text);font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:680px;margin:40px auto;padding:0 16px}
  header{text-align:center;margin-bottom:32px}
  h1{font-size:24px;margin:0 0 8px;font-weight:900}
  .subtitle{color:var(--muted);font-size:14px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:16px}
  .status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:700;font-size:14px}
  .status-badge.idle{background:#f1f5f9;color:#475569}
  .status-badge.running{background:#fef3c7;color:#92400e}
  .status-badge.success{background:#dcfce7;color:#166534}
  .status-badge.error{background:#fee2e2;color:#991b1b}
  .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:12px;border:none;font-weight:800;font-size:15px;cursor:pointer;transition:all 0.2s}
  .btn:disabled{opacity:0.5;cursor:not-allowed}
  .btn-primary{background:#1d4ed8;color:#fff}
  .btn-primary:hover:not(:disabled){background:#1e40af;transform:translateY(-2px);box-shadow:0 4px 12px rgba(29,78,216,0.3)}
  .btn-secondary{background:#f1f5f9;color:#475569;border:1px solid var(--border)}
  .btn-secondary:hover:not(:disabled){background:#e2e8f0}
  .alert{padding:12px 16px;border-radius:10px;margin:16px 0;font-size:13px;font-weight:600}
  .alert-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
  .alert-success{background:#dcfce7;color:#166534;border:1px solid #86efac}
  .alert-error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
  .log-item{padding:8px 12px;background:#f8fafc;border-left:3px solid #cbd5e1;margin:8px 0;border-radius:4px;font-size:13px}
  .log-item.success{border-left-color:#22c55e}
  .log-item.error{border-left-color:#ef4444}
  .log-item.running{border-left-color:#f59e0b}
  footer{text-align:center;margin-top:32px;font-size:12px;color:var(--muted)}
  .link{color:var(--accent);text-decoration:none;font-weight:700}
  #logContainer{max-height:300px;overflow-y:auto;margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸ”§ ê´€ë¦¬ì íŒ¨ë„</h1>
    <p class="subtitle">GitHub Actions ê¸°ë°˜ ë°ì´í„° ì—…ë°ì´íŠ¸</p>
  </header>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;font-size:16px">í˜„ì¬ ìƒíƒœ</h3>
      <span id="statusBadge" class="status-badge idle">â¸ï¸ ëŒ€ê¸° ì¤‘</span>
    </div>

    <button id="updateBtn" class="btn btn-primary">
      <span>ğŸ”„</span>
      <span>ê³µê³  ë°ì´í„° ì—…ë°ì´íŠ¸</span>
    </button>

    <div id="infoBox" class="alert alert-info">
      â° ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ GitHub Actions ì›Œí¬í”Œë¡œìš°(<code>crawl.yml</code>)ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.<br>
      ì•½ 5~10ë¶„ í›„ ë°ì´í„°ê°€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.
    </div>

    <div id="successBox" class="alert alert-success" style="display:none"></div>
    <div id="errorBox" class="alert alert-error" style="display:none"></div>

    <div id="logContainer"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px;font-size:16px">ìµœê·¼ ì—…ë°ì´íŠ¸ ê¸°ë¡</h3>
    <div id="recentRuns" style="font-size:13px;color:var(--muted)">
      ë¡œë”© ì¤‘...
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px;font-size:16px">ë¹ ë¥¸ ì´ë™</h3>
    <div style="display:grid;gap:8px">
      <a href="./index.html" class="btn btn-secondary">ğŸ“‹ ì±„ìš© ê³µê³  ë³´ê¸°</a>
      <a href="./guestbook.html" class="btn btn-secondary">ğŸ’¬ ê±´ì˜ì‚¬í•­ ê²Œì‹œíŒ</a>
      <a href="https://github.com/Kimseungwoo0407/hospital-jobs/actions" target="_blank" class="btn btn-secondary">âš™ï¸ GitHub Actions ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°</a>
    </div>
  </div>

  <footer>
    GitHub Pages Â· Python Crawler Â· Automated Workflow
  </footer>
</div>

<script>
const OWNER = "Kimseungwoo0407";
const REPO = "hospital-jobs";
const WORKFLOW_FILE = "crawl.yml";

// ======================================
// ğŸ”’ ì—¬ê¸°ì— ì•”í˜¸í™”ëœ í† í°ì„ ë„£ìœ¼ì„¸ìš”
// ======================================
// ì•”í˜¸í™” ë°©ë²•: btoa("ghp_your_token_here")
// ì˜ˆì‹œ: const ENCODED_TOKEN = "Z2hwX3lvdXJfdG9rZW5faGVyZQ==";
const ENCODED_TOKEN = "Z2hwX05xYjNWUHRiN2NmdDlCSkwwckEwTlFWN0VaMTlRbDAyeTVNdg==";
// ======================================

const statusBadge = document.getElementById('statusBadge');
const updateBtn = document.getElementById('updateBtn');
const infoBox = document.getElementById('infoBox');
const successBox = document.getElementById('successBox');
const errorBox = document.getElementById('errorBox');
const logContainer = document.getElementById('logContainer');
const recentRuns = document.getElementById('recentRuns');

let checkInterval = null;
let isRunning = false; // ì‹¤í–‰ ì¤‘ ì—¬ë¶€ í”Œë˜ê·¸

// í† í° ë””ì½”ë”©
function getToken() {
  try {
    return atob(ENCODED_TOKEN);
  } catch (e) {
    return null;
  }
}

// ë¡œê·¸ ì¶”ê°€
function addLog(message, type = 'info') {
  const log = document.createElement('div');
  log.className = `log-item ${type}`;
  log.textContent = `${new Date().toLocaleTimeString('ko-KR')} - ${message}`;
  logContainer.insertBefore(log, logContainer.firstChild);
}

// ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìƒíƒœ í™•ì¸
async function checkWorkflowStatus() {
  const token = getToken();
  if (!token) return;

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=1`,
      {
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        }
      }
    );

    if (res.ok) {
      const data = await res.json();
      if (data.workflow_runs && data.workflow_runs.length > 0) {
        const latestRun = data.workflow_runs[0];
        updateStatus(latestRun.status, latestRun.conclusion);
        
        // ì™„ë£Œë˜ë©´ ì²´í¬ ì¤‘ì§€
        if (latestRun.status === 'completed') {
          if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
          }
          
          if (latestRun.conclusion === 'success') {
            successBox.textContent = `âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ! (${new Date(latestRun.updated_at).toLocaleString('ko-KR')})`;
            successBox.style.display = 'block';
            addLog('ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
          } else {
            errorBox.textContent = `âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${latestRun.conclusion}`;
            errorBox.style.display = 'block';
            addLog(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${latestRun.conclusion}`, 'error');
          }
        }
      }
    }
  } catch (err) {
    console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', err);
  }
}

// ìƒíƒœ ì—…ë°ì´íŠ¸
function updateStatus(status, conclusion) {
  if (status === 'in_progress' || status === 'queued') {
    statusBadge.textContent = 'ğŸš€ ì‹¤í–‰ ì¤‘...';
    statusBadge.className = 'status-badge running';
    updateBtn.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
    isRunning = true;
  } else if (status === 'completed') {
    if (conclusion === 'success') {
      statusBadge.textContent = 'âœ… ì™„ë£Œ';
      statusBadge.className = 'status-badge success';
    } else {
      statusBadge.textContent = 'âŒ ì‹¤íŒ¨';
      statusBadge.className = 'status-badge error';
    }
    updateBtn.disabled = false; // ë²„íŠ¼ í™œì„±í™”
    isRunning = false;
  }
}

// ìµœê·¼ ì‹¤í–‰ ê¸°ë¡ ë¡œë“œ
async function loadRecentRuns() {
  const token = getToken();
  if (!token) {
    recentRuns.innerHTML = 'âš ï¸ í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
    return;
  }

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=5`,
      {
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        }
      }
    );

    if (res.ok) {
      const data = await res.json();
      if (data.workflow_runs && data.workflow_runs.length > 0) {
        let html = '<div style="display:grid;gap:8px">';
        data.workflow_runs.slice(0, 5).forEach(run => {
          const icon = run.conclusion === 'success' ? 'âœ…' : 
                      run.conclusion === 'failure' ? 'âŒ' : 'â³';
          const status = run.status === 'completed' ? run.conclusion : run.status;
          const date = new Date(run.created_at).toLocaleString('ko-KR');
          html += `
            <div style="padding:8px;background:#f8fafc;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
              <span>${icon} ${status}</span>
              <span style="color:var(--muted);font-size:12px">${date}</span>
            </div>
          `;
        });
        html += '</div>';
        recentRuns.innerHTML = html;
        
        // ìµœì‹  ì‹¤í–‰ì´ ì§„í–‰ ì¤‘ì´ë©´ ìë™ìœ¼ë¡œ ìƒíƒœ ì²´í¬ ì‹œì‘
        const latestRun = data.workflow_runs[0];
        if (latestRun.status !== 'completed') {
          updateStatus(latestRun.status, latestRun.conclusion);
          startStatusCheck();
        } else {
          updateStatus(latestRun.status, latestRun.conclusion);
        }
      } else {
        recentRuns.textContent = 'ì•„ì§ ì‹¤í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
      }
    } else {
      recentRuns.textContent = 'ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }
  } catch (err) {
    recentRuns.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
  }
}

// ìƒíƒœ ì²´í¬ ì‹œì‘
function startStatusCheck() {
  if (checkInterval) clearInterval(checkInterval);
  checkInterval = setInterval(checkWorkflowStatus, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬
  checkWorkflowStatus(); // ì¦‰ì‹œ í•œ ë²ˆ ì²´í¬
}

// í¬ë¡¤ë§ ì‹¤í–‰
async function triggerCrawl() {
  const token = getToken();

  if (!token || token === "ì—¬ê¸°ì—_Base64ë¡œ_ì¸ì½”ë”©ëœ_í† í°ì„_ë„£ìœ¼ì„¸ìš”") {
    alert("âŒ í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì†ŒìŠ¤ì½”ë“œì—ì„œ ENCODED_TOKENì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
    return;
  }

  // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì°¨ë‹¨
  if (isRunning) {
    alert("âš ï¸ ì´ë¯¸ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\nì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
    return;
  }

  updateBtn.disabled = true;
  isRunning = true;
  statusBadge.textContent = "ğŸš€ ì‹¤í–‰ ìš”ì²­ ì¤‘...";
  statusBadge.className = "status-badge running";
  successBox.style.display = 'none';
  errorBox.style.display = 'none';
  
  addLog('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìš”ì²­ ì‹œì‘', 'info');

  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches`,
      {
        method: "POST",
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
        },
        body: JSON.stringify({ ref: "main" }),
      }
    );

    if (res.ok || res.status === 204) {
      statusBadge.textContent = "ğŸš€ ì‹¤í–‰ ì¤‘...";
      statusBadge.className = "status-badge running";
      infoBox.style.display = 'none';
      addLog('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œì‘ë¨', 'running');
      
      // ìƒíƒœ ì²´í¬ ì‹œì‘
      setTimeout(() => {
        startStatusCheck();
        loadRecentRuns();
      }, 3000); // 3ì´ˆ í›„ ìƒíƒœ ì²´í¬ ì‹œì‘
      
    } else {
      const text = await res.text();
      statusBadge.textContent = "âŒ ì˜¤ë¥˜";
      statusBadge.className = "status-badge error";
      errorBox.style.display = "block";
      errorBox.textContent = `ì‹¤í–‰ ì‹¤íŒ¨: ${text}`;
      addLog(`ì‹¤í–‰ ì‹¤íŒ¨: ${text}`, 'error');
      isRunning = false;
    }
  } catch (err) {
    statusBadge.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
    statusBadge.className = "status-badge error";
    errorBox.style.display = "block";
    errorBox.textContent = `ì˜¤ë¥˜: ${err.message}`;
    addLog(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`, 'error');
    isRunning = false;
  } finally {
    updateBtn.disabled = isRunning; // ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±í™”
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
updateBtn.addEventListener('click', triggerCrawl);

// í˜ì´ì§€ ë¡œë“œì‹œ ìµœê·¼ ì‹¤í–‰ ê¸°ë¡ ë¡œë“œ
loadRecentRuns();
</script>
</body>
</html>